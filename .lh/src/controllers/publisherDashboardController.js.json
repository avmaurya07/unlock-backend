{
    "sourceFile": "src/controllers/publisherDashboardController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 13,
            "patches": [
                {
                    "date": 1766931140119,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1767934361868,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -90,4 +90,149 @@\n   } catch (err) {\n     res.status(500).json({ success: false, message: err.message });\n   }\n };\n+\n+\n+\n+\n+// optional — only if your Listing uses listingType ref\n+let ListingType;\n+try {\n+  ListingType = require(\"../models/ListingType\");\n+} catch (e) {\n+  ListingType = null;\n+}\n+\n+// helper: resolve event type filter (works for both schemas)\n+async function getEventTypeFilter() {\n+  // Case A: Listing has listingType ref\n+  if (Listing.schema.path(\"listingType\") && ListingType) {\n+    const eventType = await ListingType.findOne({\n+      slug: \"event\",\n+      isActive: true,\n+    });\n+\n+    if (!eventType) {\n+      return { __error: \"ListingType 'event' not found. Create it first.\" };\n+    }\n+\n+    return { listingType: eventType._id };\n+  }\n+\n+  // Case B: Listing has type string\n+  if (Listing.schema.path(\"type\")) {\n+    return { type: \"event\" };\n+  }\n+\n+  // fallback\n+  return { __error: \"Listing schema has no 'type' or 'listingType' field.\" };\n+}\n+\n+/**\n+ * ✅ GET /api/publisher/dashboard/events\n+ * Query:\n+ *  - status=pending|approved|rejected|all\n+ *  - q=search text (title/location)\n+ *  - page=1\n+ *  - limit=10\n+ */\n+exports.getMyEvents = async (req, res) => {\n+  try {\n+    const publisher = await Publisher.findOne({ userId: req.user.id });\n+    if (!publisher) {\n+      return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+    }\n+\n+    const { status = \"all\", q = \"\", page = 1, limit = 10 } = req.query;\n+\n+    const typeFilter = await getEventTypeFilter();\n+    if (typeFilter.__error) {\n+      return res.status(400).json({ success: false, message: typeFilter.__error });\n+    }\n+\n+    const filter = {\n+      publisherId: publisher._id,\n+      ...typeFilter,\n+    };\n+\n+    if (status !== \"all\") filter.status = status;\n+\n+    if (q.trim()) {\n+      const regex = new RegExp(q.trim(), \"i\");\n+      filter.$or = [{ title: regex }, { location: regex }];\n+    }\n+\n+    const pageNum = Math.max(parseInt(page, 10) || 1, 1);\n+    const limitNum = Math.min(Math.max(parseInt(limit, 10) || 10, 1), 50);\n+    const skip = (pageNum - 1) * limitNum;\n+\n+    const [total, events] = await Promise.all([\n+      Listing.countDocuments(filter),\n+      Listing.find(filter)\n+        .sort({ createdAt: -1 })\n+        .skip(skip)\n+        .limit(limitNum)\n+        .populate(\"listingType\", \"name slug\")\n+    ]);\n+\n+    return res.json({\n+      success: true,\n+      page: pageNum,\n+      limit: limitNum,\n+      total,\n+      pages: Math.ceil(total / limitNum),\n+      events,\n+    });\n+  } catch (err) {\n+    return res.status(500).json({ success: false, message: err.message });\n+  }\n+};\n+\n+/**\n+ * ✅ POST /api/publisher/dashboard/events\n+ * Body:\n+ *  - title, description (required)\n+ *  - location, startDate, endDate, deadline (optional)\n+ */\n+exports.createEvent = async (req, res) => {\n+  try {\n+    const publisher = await Publisher.findOne({ userId: req.user.id });\n+    if (!publisher) {\n+      return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+    }\n+\n+    const { title, description, location, startDate, endDate, deadline, attachments } = req.body;\n+\n+    if (!title || !description) {\n+      return res.status(400).json({ success: false, message: \"title and description are required\" });\n+    }\n+\n+    const typeFilter = await getEventTypeFilter();\n+    if (typeFilter.__error) {\n+      return res.status(400).json({ success: false, message: typeFilter.__error });\n+    }\n+\n+    const payload = {\n+      publisherId: publisher._id,\n+      title,\n+      description,\n+      location,\n+      startDate,\n+      endDate,\n+      deadline,\n+      attachments: Array.isArray(attachments) ? attachments : [],\n+      status: \"pending\", // always pending until admin approves\n+      ...typeFilter,\n+    };\n+\n+    const event = await Listing.create(payload);\n+\n+    return res.json({\n+      success: true,\n+      message: \"Event created (Pending admin approval)\",\n+      event,\n+    });\n+  } catch (err) {\n+    return res.status(500).json({ success: false, message: err.message });\n+  }\n+};\n\\ No newline at end of file\n"
                },
                {
                    "date": 1767935331986,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -127,112 +127,4 @@\n   // fallback\n   return { __error: \"Listing schema has no 'type' or 'listingType' field.\" };\n }\n \n-/**\n- * ✅ GET /api/publisher/dashboard/events\n- * Query:\n- *  - status=pending|approved|rejected|all\n- *  - q=search text (title/location)\n- *  - page=1\n- *  - limit=10\n- */\n-exports.getMyEvents = async (req, res) => {\n-  try {\n-    const publisher = await Publisher.findOne({ userId: req.user.id });\n-    if (!publisher) {\n-      return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-    }\n-\n-    const { status = \"all\", q = \"\", page = 1, limit = 10 } = req.query;\n-\n-    const typeFilter = await getEventTypeFilter();\n-    if (typeFilter.__error) {\n-      return res.status(400).json({ success: false, message: typeFilter.__error });\n-    }\n-\n-    const filter = {\n-      publisherId: publisher._id,\n-      ...typeFilter,\n-    };\n-\n-    if (status !== \"all\") filter.status = status;\n-\n-    if (q.trim()) {\n-      const regex = new RegExp(q.trim(), \"i\");\n-      filter.$or = [{ title: regex }, { location: regex }];\n-    }\n-\n-    const pageNum = Math.max(parseInt(page, 10) || 1, 1);\n-    const limitNum = Math.min(Math.max(parseInt(limit, 10) || 10, 1), 50);\n-    const skip = (pageNum - 1) * limitNum;\n-\n-    const [total, events] = await Promise.all([\n-      Listing.countDocuments(filter),\n-      Listing.find(filter)\n-        .sort({ createdAt: -1 })\n-        .skip(skip)\n-        .limit(limitNum)\n-        .populate(\"listingType\", \"name slug\")\n-    ]);\n-\n-    return res.json({\n-      success: true,\n-      page: pageNum,\n-      limit: limitNum,\n-      total,\n-      pages: Math.ceil(total / limitNum),\n-      events,\n-    });\n-  } catch (err) {\n-    return res.status(500).json({ success: false, message: err.message });\n-  }\n-};\n-\n-/**\n- * ✅ POST /api/publisher/dashboard/events\n- * Body:\n- *  - title, description (required)\n- *  - location, startDate, endDate, deadline (optional)\n- */\n-exports.createEvent = async (req, res) => {\n-  try {\n-    const publisher = await Publisher.findOne({ userId: req.user.id });\n-    if (!publisher) {\n-      return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-    }\n-\n-    const { title, description, location, startDate, endDate, deadline, attachments } = req.body;\n-\n-    if (!title || !description) {\n-      return res.status(400).json({ success: false, message: \"title and description are required\" });\n-    }\n-\n-    const typeFilter = await getEventTypeFilter();\n-    if (typeFilter.__error) {\n-      return res.status(400).json({ success: false, message: typeFilter.__error });\n-    }\n-\n-    const payload = {\n-      publisherId: publisher._id,\n-      title,\n-      description,\n-      location,\n-      startDate,\n-      endDate,\n-      deadline,\n-      attachments: Array.isArray(attachments) ? attachments : [],\n-      status: \"pending\", // always pending until admin approves\n-      ...typeFilter,\n-    };\n-\n-    const event = await Listing.create(payload);\n-\n-    return res.json({\n-      success: true,\n-      message: \"Event created (Pending admin approval)\",\n-      event,\n-    });\n-  } catch (err) {\n-    return res.status(500).json({ success: false, message: err.message });\n-  }\n-};\n\\ No newline at end of file\n"
                },
                {
                    "date": 1767937664794,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,12 @@\n const Listing = require(\"../models/Listing\");\n const Publisher = require(\"../models/Publisher\");\n \n+const ListingType = require(\"../models/ListingType\");\n \n+const authDisabled = () => process.env.DISABLE_AUTH === \"true\";\n+\n+\n // DASHBOARD SUMMARY\n exports.getDashboardSummary = async (req, res) => {\n   try {\n     const publisher = await Publisher.findOne({ userId: req.user.id });\n@@ -127,4 +131,57 @@\n   // fallback\n   return { __error: \"Listing schema has no 'type' or 'listingType' field.\" };\n }\n \n+exports.getPublisherEvents = async (req, res) => {\n+  try {\n+    const publisher = await Publisher.findOne({ userId: req.user.id });\n+    if (!publisher) {\n+      return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+    }\n+\n+    const events = await Listing.find({\n+      publisherId: publisher._id,\n+      type: \"event\",\n+    }).sort({ createdAt: -1 });\n+\n+    return res.json({ success: true, events });\n+  } catch (err) {\n+    return res.status(500).json({ success: false, message: err.message });\n+  }\n+};\n+\n+exports.createPublisherEvent = async (req, res) => {\n+  try {\n+    const publisher = await Publisher.findOne({ userId: req.user.id });\n+    if (!publisher) {\n+      return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+    }\n+\n+    const {\n+      title,\n+      description,\n+      location,\n+      deadline,\n+      startDate,\n+      endDate,\n+      attachments,\n+    } = req.body;\n+\n+    const event = await Listing.create({\n+      publisherId: publisher._id,\n+      type: \"event\",\n+      title,\n+      description,\n+      location,\n+      deadline,\n+      startDate,\n+      endDate,\n+      attachments: attachments || [],\n+      status: \"pending\", // ✅ admin approval\n+    });\n+\n+    return res.json({ success: true, message: \"Event created (pending approval)\", event });\n+  } catch (err) {\n+    return res.status(500).json({ success: false, message: err.message });\n+  }\n+};\n\\ No newline at end of file\n"
                },
                {
                    "date": 1767937696878,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -131,57 +131,144 @@\n   // fallback\n   return { __error: \"Listing schema has no 'type' or 'listingType' field.\" };\n }\n \n+\n+\n+\n+async function getEventTypeId() {\n+  // If you use ListingType model (dynamic types)\n+  // Keep key = \"event\" in DB for event type\n+  const t = await ListingType.findOne({ key: \"event\" }).select(\"_id\");\n+  return t?._id || null;\n+}\n+\n exports.getPublisherEvents = async (req, res) => {\n   try {\n-    const publisher = await Publisher.findOne({ userId: req.user.id });\n-    if (!publisher) {\n-      return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+    const { status = \"all\", q = \"\", page = 1, limit = 10 } = req.query;\n+\n+    const pageNum = Math.max(parseInt(page, 10) || 1, 1);\n+    const limitNum = Math.min(Math.max(parseInt(limit, 10) || 10, 1), 50);\n+    const skip = (pageNum - 1) * limitNum;\n+\n+    // ✅ DEV MODE: no auth => show all events OR allow publisherId filter via query\n+    let publisherId = null;\n+\n+    if (authDisabled()) {\n+      publisherId = req.query.publisherId || null; // optional\n+    } else {\n+      // PROD mode: must have req.user\n+      if (!req.user?.id) {\n+        return res.status(401).json({ success: false, message: \"Unauthorized\" });\n+      }\n+      const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n+      if (!pub) {\n+        return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+      }\n+      publisherId = pub._id;\n     }\n \n-    const events = await Listing.find({\n-      publisherId: publisher._id,\n-      type: \"event\",\n-    }).sort({ createdAt: -1 });\n+    const eventTypeId = await getEventTypeId();\n \n-    return res.json({ success: true, events });\n+    const filter = {};\n+\n+    // Filter by publisher if available\n+    if (publisherId) filter.publisherId = publisherId;\n+\n+    // Filter by \"event\" type (supports both ObjectId-based and string-based schemas)\n+    if (eventTypeId) {\n+      filter.$or = [{ type: eventTypeId }, { listingType: eventTypeId }, { type: \"event\" }];\n+    } else {\n+      filter.type = \"event\"; // fallback if ListingType not created yet\n+    }\n+\n+    // status filter (approved/pending/rejected/all)\n+    if (status !== \"all\") filter.status = status;\n+\n+    // search\n+    if (q?.trim()) {\n+      filter.title = { $regex: q.trim(), $options: \"i\" };\n+    }\n+\n+    const [items, total] = await Promise.all([\n+      Listing.find(filter).sort({ createdAt: -1 }).skip(skip).limit(limitNum),\n+      Listing.countDocuments(filter),\n+    ]);\n+\n+    return res.json({\n+      success: true,\n+      items,\n+      pagination: {\n+        page: pageNum,\n+        limit: limitNum,\n+        total,\n+        pages: Math.ceil(total / limitNum),\n+      },\n+    });\n   } catch (err) {\n+    console.error(\"getPublisherEvents error:\", err);\n     return res.status(500).json({ success: false, message: err.message });\n   }\n };\n \n exports.createPublisherEvent = async (req, res) => {\n   try {\n-    const publisher = await Publisher.findOne({ userId: req.user.id });\n-    if (!publisher) {\n-      return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-    }\n-\n     const {\n       title,\n       description,\n       location,\n       deadline,\n       startDate,\n       endDate,\n-      attachments,\n+      attachments = [],\n+      publisherId: bodyPublisherId, // ✅ dev mode support\n     } = req.body;\n \n-    const event = await Listing.create({\n-      publisherId: publisher._id,\n-      type: \"event\",\n+    if (!title || !description) {\n+      return res.status(400).json({ success: false, message: \"title and description are required\" });\n+    }\n+\n+    let publisherId = null;\n+\n+    if (authDisabled()) {\n+      // In dev mode you can pass publisherId from frontend until auth is ready\n+      publisherId = bodyPublisherId || null;\n+      if (!publisherId) {\n+        return res.status(400).json({\n+          success: false,\n+          message: \"DEV MODE: please send publisherId in body to create event\",\n+        });\n+      }\n+    } else {\n+      if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n+\n+      const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n+      if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+\n+      publisherId = pub._id;\n+    }\n+\n+    const eventTypeId = await getEventTypeId();\n+\n+    const doc = await Listing.create({\n+      publisherId,\n+      // supports both schemas:\n+      type: eventTypeId || \"event\",\n+      listingType: eventTypeId || undefined,\n+\n       title,\n       description,\n       location,\n       deadline,\n       startDate,\n       endDate,\n-      attachments: attachments || [],\n-      status: \"pending\", // ✅ admin approval\n+      attachments,\n+\n+      status: \"pending\", // admin approval\n     });\n \n-    return res.json({ success: true, message: \"Event created (pending approval)\", event });\n+    return res.json({ success: true, message: \"Event created (pending approval)\", item: doc });\n   } catch (err) {\n+    console.error(\"createPublisherEvent error:\", err);\n     return res.status(500).json({ success: false, message: err.message });\n   }\n };\n\\ No newline at end of file\n"
                },
                {
                    "date": 1767937873950,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,44 +98,13 @@\n \n \n \n \n-// optional — only if your Listing uses listingType ref\n-let ListingType;\n-try {\n-  ListingType = require(\"../models/ListingType\");\n-} catch (e) {\n-  ListingType = null;\n-}\n \n-// helper: resolve event type filter (works for both schemas)\n-async function getEventTypeFilter() {\n-  // Case A: Listing has listingType ref\n-  if (Listing.schema.path(\"listingType\") && ListingType) {\n-    const eventType = await ListingType.findOne({\n-      slug: \"event\",\n-      isActive: true,\n-    });\n \n-    if (!eventType) {\n-      return { __error: \"ListingType 'event' not found. Create it first.\" };\n-    }\n \n-    return { listingType: eventType._id };\n-  }\n \n-  // Case B: Listing has type string\n-  if (Listing.schema.path(\"type\")) {\n-    return { type: \"event\" };\n-  }\n \n-  // fallback\n-  return { __error: \"Listing schema has no 'type' or 'listingType' field.\" };\n-}\n-\n-\n-\n-\n async function getEventTypeId() {\n   // If you use ListingType model (dynamic types)\n   // Keep key = \"event\" in DB for event type\n   const t = await ListingType.findOne({ key: \"event\" }).select(\"_id\");\n"
                },
                {
                    "date": 1767938192343,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,114 +1,23 @@\n const Listing = require(\"../models/Listing\");\n const Publisher = require(\"../models/Publisher\");\n-\n const ListingType = require(\"../models/ListingType\");\n \n const authDisabled = () => process.env.DISABLE_AUTH === \"true\";\n \n+async function ensureEventTypeId() {\n+  // ListingType schema usually: { name, description, isActive }\n+  let t = await ListingType.findOne({ name: \"event\", isActive: true }).select(\"_id\");\n \n-// DASHBOARD SUMMARY\n-exports.getDashboardSummary = async (req, res) => {\n-  try {\n-    const publisher = await Publisher.findOne({ userId: req.user.id });\n-    if (!publisher) {\n-      return res.status(404).json({\n-        success: false,\n-        message: \"Publisher profile not found\"\n-      });\n-    }\n-\n-    // Count by type\n-    const counts = await Listing.aggregate([\n-      { $match: { publisherId: publisher._id } },\n-      {\n-        $group: {\n-          _id: \"$type\",\n-          count: { $sum: 1 }\n-        }\n-      }\n-    ]);\n-\n-    // Convert aggregation results into object { typeId: count }\n-    const countMap = {};\n-    counts.forEach(item => (countMap[item._id] = item.count));\n-\n-    // Pending, Approved, Rejected counts\n-    const statusCounts = await Listing.aggregate([\n-      { $match: { publisherId: publisher._id } },\n-      {\n-        $group: {\n-          _id: \"$status\",\n-          count: { $sum: 1 }\n-        }\n-      }\n-    ]);\n-\n-    const statusMap = {};\n-    statusCounts.forEach(s => (statusMap[s._id] = s.count));\n-\n-    res.json({\n-      success: true,\n-      counts: countMap,\n-      statusCounts: statusMap\n+  // DEV mode me auto create\n+  if (!t && authDisabled()) {\n+    t = await ListingType.create({\n+      name: \"event\",\n+      description: \"Events\",\n+      isActive: true,\n     });\n-\n-  } catch (err) {\n-    res.status(500).json({ success: false, message: err.message });\n   }\n-};\n \n-\n-// RECENT LISTINGS\n-exports.getRecentListings = async (req, res) => {\n-  try {\n-    const publisher = await Publisher.findOne({ userId: req.user.id });\n-\n-    const listings = await Listing.find({ publisherId: publisher._id })\n-      .populate(\"type\", \"name\")\n-      .sort({ createdAt: -1 })\n-      .limit(5);\n-\n-    res.json({\n-      success: true,\n-      listings\n-    });\n-\n-  } catch (err) {\n-    res.status(500).json({ success: false, message: err.message });\n-  }\n-};\n-\n-\n-// SUBSCRIPTION INFO\n-exports.getSubscriptionInfo = async (req, res) => {\n-  try {\n-    const publisher = await Publisher.findOne({ userId: req.user.id });\n-\n-    res.json({\n-      success: true,\n-      subscriptionStatus: publisher.subscriptionStatus,\n-      expiry: publisher.subscriptionExpiry,\n-      servicePlanActive: publisher.servicePlanActive\n-    });\n-\n-  } catch (err) {\n-    res.status(500).json({ success: false, message: err.message });\n-  }\n-};\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-async function getEventTypeId() {\n-  // If you use ListingType model (dynamic types)\n-  // Keep key = \"event\" in DB for event type\n-  const t = await ListingType.findOne({ key: \"event\" }).select(\"_id\");\n   return t?._id || null;\n }\n \n exports.getPublisherEvents = async (req, res) => {\n@@ -118,47 +27,35 @@\n     const pageNum = Math.max(parseInt(page, 10) || 1, 1);\n     const limitNum = Math.min(Math.max(parseInt(limit, 10) || 10, 1), 50);\n     const skip = (pageNum - 1) * limitNum;\n \n-    // ✅ DEV MODE: no auth => show all events OR allow publisherId filter via query\n+    // ✅ get event type ObjectId\n+    const eventTypeId = await ensureEventTypeId();\n+    if (!eventTypeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: \"ListingType 'event' not found. Create it first.\",\n+      });\n+    }\n+\n+    // ✅ publisherId resolution\n     let publisherId = null;\n \n     if (authDisabled()) {\n-      publisherId = req.query.publisherId || null; // optional\n+      publisherId = req.query.publisherId || null; // optional in dev\n     } else {\n-      // PROD mode: must have req.user\n-      if (!req.user?.id) {\n-        return res.status(401).json({ success: false, message: \"Unauthorized\" });\n-      }\n+      if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n       const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n-      if (!pub) {\n-        return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-      }\n+      if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n       publisherId = pub._id;\n     }\n \n-    const eventTypeId = await getEventTypeId();\n+    const filter = { type: eventTypeId }; // ✅ always ObjectId\n \n-    const filter = {};\n-\n-    // Filter by publisher if available\n     if (publisherId) filter.publisherId = publisherId;\n-\n-    // Filter by \"event\" type (supports both ObjectId-based and string-based schemas)\n-    if (eventTypeId) {\n-      filter.$or = [{ type: eventTypeId }, { listingType: eventTypeId }, { type: \"event\" }];\n-    } else {\n-      filter.type = \"event\"; // fallback if ListingType not created yet\n-    }\n-\n-    // status filter (approved/pending/rejected/all)\n     if (status !== \"all\") filter.status = status;\n+    if (q?.trim()) filter.title = { $regex: q.trim(), $options: \"i\" };\n \n-    // search\n-    if (q?.trim()) {\n-      filter.title = { $regex: q.trim(), $options: \"i\" };\n-    }\n-\n     const [items, total] = await Promise.all([\n       Listing.find(filter).sort({ createdAt: -1 }).skip(skip).limit(limitNum),\n       Listing.countDocuments(filter),\n     ]);\n@@ -188,56 +85,54 @@\n       deadline,\n       startDate,\n       endDate,\n       attachments = [],\n-      publisherId: bodyPublisherId, // ✅ dev mode support\n+      publisherId: bodyPublisherId, // dev mode\n     } = req.body;\n \n     if (!title || !description) {\n       return res.status(400).json({ success: false, message: \"title and description are required\" });\n     }\n \n+    const eventTypeId = await ensureEventTypeId();\n+    if (!eventTypeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: \"ListingType 'event' not found. Create it first.\",\n+      });\n+    }\n+\n     let publisherId = null;\n-\n     if (authDisabled()) {\n-      // In dev mode you can pass publisherId from frontend until auth is ready\n       publisherId = bodyPublisherId || null;\n       if (!publisherId) {\n         return res.status(400).json({\n           success: false,\n-          message: \"DEV MODE: please send publisherId in body to create event\",\n+          message: \"DEV MODE: send publisherId in body to create event\",\n         });\n       }\n     } else {\n       if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n-\n       const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n       if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-\n       publisherId = pub._id;\n     }\n \n-    const eventTypeId = await getEventTypeId();\n-\n     const doc = await Listing.create({\n       publisherId,\n-      // supports both schemas:\n-      type: eventTypeId || \"event\",\n-      listingType: eventTypeId || undefined,\n-\n+      type: eventTypeId,       // ✅ ObjectId\n       title,\n       description,\n       location,\n       deadline,\n       startDate,\n       endDate,\n\\ No newline at end of file\n       attachments,\n-\n-      status: \"pending\", // admin approval\n+      status: \"pending\",\n     });\n \n     return res.json({ success: true, message: \"Event created (pending approval)\", item: doc });\n   } catch (err) {\n     console.error(\"createPublisherEvent error:\", err);\n     return res.status(500).json({ success: false, message: err.message });\n   }\n-};\n+};\n"
                },
                {
                    "date": 1767938214221,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,23 +1,114 @@\n const Listing = require(\"../models/Listing\");\n const Publisher = require(\"../models/Publisher\");\n+\n const ListingType = require(\"../models/ListingType\");\n \n const authDisabled = () => process.env.DISABLE_AUTH === \"true\";\n \n-async function ensureEventTypeId() {\n-  // ListingType schema usually: { name, description, isActive }\n-  let t = await ListingType.findOne({ name: \"event\", isActive: true }).select(\"_id\");\n \n-  // DEV mode me auto create\n-  if (!t && authDisabled()) {\n-    t = await ListingType.create({\n-      name: \"event\",\n-      description: \"Events\",\n-      isActive: true,\n+// DASHBOARD SUMMARY\n+exports.getDashboardSummary = async (req, res) => {\n+  try {\n+    const publisher = await Publisher.findOne({ userId: req.user.id });\n+    if (!publisher) {\n+      return res.status(404).json({\n+        success: false,\n+        message: \"Publisher profile not found\"\n+      });\n+    }\n+\n+    // Count by type\n+    const counts = await Listing.aggregate([\n+      { $match: { publisherId: publisher._id } },\n+      {\n+        $group: {\n+          _id: \"$type\",\n+          count: { $sum: 1 }\n+        }\n+      }\n+    ]);\n+\n+    // Convert aggregation results into object { typeId: count }\n+    const countMap = {};\n+    counts.forEach(item => (countMap[item._id] = item.count));\n+\n+    // Pending, Approved, Rejected counts\n+    const statusCounts = await Listing.aggregate([\n+      { $match: { publisherId: publisher._id } },\n+      {\n+        $group: {\n+          _id: \"$status\",\n+          count: { $sum: 1 }\n+        }\n+      }\n+    ]);\n+\n+    const statusMap = {};\n+    statusCounts.forEach(s => (statusMap[s._id] = s.count));\n+\n+    res.json({\n+      success: true,\n+      counts: countMap,\n+      statusCounts: statusMap\n     });\n+\n+  } catch (err) {\n+    res.status(500).json({ success: false, message: err.message });\n   }\n+};\n \n+\n+// RECENT LISTINGS\n+exports.getRecentListings = async (req, res) => {\n+  try {\n+    const publisher = await Publisher.findOne({ userId: req.user.id });\n+\n+    const listings = await Listing.find({ publisherId: publisher._id })\n+      .populate(\"type\", \"name\")\n+      .sort({ createdAt: -1 })\n+      .limit(5);\n+\n+    res.json({\n+      success: true,\n+      listings\n+    });\n+\n+  } catch (err) {\n+    res.status(500).json({ success: false, message: err.message });\n+  }\n+};\n+\n+\n+// SUBSCRIPTION INFO\n+exports.getSubscriptionInfo = async (req, res) => {\n+  try {\n+    const publisher = await Publisher.findOne({ userId: req.user.id });\n+\n+    res.json({\n+      success: true,\n+      subscriptionStatus: publisher.subscriptionStatus,\n+      expiry: publisher.subscriptionExpiry,\n+      servicePlanActive: publisher.servicePlanActive\n+    });\n+\n+  } catch (err) {\n+    res.status(500).json({ success: false, message: err.message });\n+  }\n+};\n+\n+\n+\n+\n+\n+\n+\n+\n+\n+async function getEventTypeId() {\n+  // If you use ListingType model (dynamic types)\n+  // Keep key = \"event\" in DB for event type\n+  const t = await ListingType.findOne({ key: \"event\" }).select(\"_id\");\n   return t?._id || null;\n }\n \n exports.getPublisherEvents = async (req, res) => {\n@@ -27,35 +118,47 @@\n     const pageNum = Math.max(parseInt(page, 10) || 1, 1);\n     const limitNum = Math.min(Math.max(parseInt(limit, 10) || 10, 1), 50);\n     const skip = (pageNum - 1) * limitNum;\n \n-    // ✅ get event type ObjectId\n-    const eventTypeId = await ensureEventTypeId();\n-    if (!eventTypeId) {\n-      return res.status(400).json({\n-        success: false,\n-        message: \"ListingType 'event' not found. Create it first.\",\n-      });\n-    }\n-\n-    // ✅ publisherId resolution\n+    // ✅ DEV MODE: no auth => show all events OR allow publisherId filter via query\n     let publisherId = null;\n \n     if (authDisabled()) {\n-      publisherId = req.query.publisherId || null; // optional in dev\n+      publisherId = req.query.publisherId || null; // optional\n     } else {\n-      if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n+      // PROD mode: must have req.user\n+      if (!req.user?.id) {\n+        return res.status(401).json({ success: false, message: \"Unauthorized\" });\n+      }\n       const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n-      if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+      if (!pub) {\n+        return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+      }\n       publisherId = pub._id;\n     }\n \n-    const filter = { type: eventTypeId }; // ✅ always ObjectId\n+    const eventTypeId = await getEventTypeId();\n \n+    const filter = {};\n+\n+    // Filter by publisher if available\n     if (publisherId) filter.publisherId = publisherId;\n+\n+    // Filter by \"event\" type (supports both ObjectId-based and string-based schemas)\n+    if (eventTypeId) {\n+      filter.$or = [{ type: eventTypeId }, { listingType: eventTypeId }, { type: \"event\" }];\n+    } else {\n+      filter.type = \"event\"; // fallback if ListingType not created yet\n+    }\n+\n+    // status filter (approved/pending/rejected/all)\n     if (status !== \"all\") filter.status = status;\n-    if (q?.trim()) filter.title = { $regex: q.trim(), $options: \"i\" };\n \n+    // search\n+    if (q?.trim()) {\n+      filter.title = { $regex: q.trim(), $options: \"i\" };\n+    }\n+\n     const [items, total] = await Promise.all([\n       Listing.find(filter).sort({ createdAt: -1 }).skip(skip).limit(limitNum),\n       Listing.countDocuments(filter),\n     ]);\n@@ -85,50 +188,52 @@\n       deadline,\n       startDate,\n       endDate,\n       attachments = [],\n-      publisherId: bodyPublisherId, // dev mode\n+      publisherId: bodyPublisherId, // ✅ dev mode support\n     } = req.body;\n \n     if (!title || !description) {\n       return res.status(400).json({ success: false, message: \"title and description are required\" });\n     }\n \n-    const eventTypeId = await ensureEventTypeId();\n-    if (!eventTypeId) {\n-      return res.status(400).json({\n-        success: false,\n-        message: \"ListingType 'event' not found. Create it first.\",\n-      });\n-    }\n+    let publisherId = null;\n \n-    let publisherId = null;\n     if (authDisabled()) {\n+      // In dev mode you can pass publisherId from frontend until auth is ready\n       publisherId = bodyPublisherId || null;\n       if (!publisherId) {\n         return res.status(400).json({\n           success: false,\n-          message: \"DEV MODE: send publisherId in body to create event\",\n+          message: \"DEV MODE: please send publisherId in body to create event\",\n         });\n       }\n     } else {\n       if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n+\n       const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n       if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n+\n       publisherId = pub._id;\n     }\n \n+    const eventTypeId = await getEventTypeId();\n+\n     const doc = await Listing.create({\n       publisherId,\n-      type: eventTypeId,       // ✅ ObjectId\n+      // supports both schemas:\n+      type: eventTypeId || \"event\",\n+      listingType: eventTypeId || undefined,\n+\n       title,\n       description,\n       location,\n       deadline,\n       startDate,\n       endDate,\n       attachments,\n-      status: \"pending\",\n+\n+      status: \"pending\", // admin approval\n     });\n \n     return res.json({ success: true, message: \"Event created (pending approval)\", item: doc });\n   } catch (err) {\n"
                },
                {
                    "date": 1767938224902,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,6 @@\n const Listing = require(\"../models/Listing\");\n const Publisher = require(\"../models/Publisher\");\n-\n const ListingType = require(\"../models/ListingType\");\n \n const authDisabled = () => process.env.DISABLE_AUTH === \"true\";\n \n"
                },
                {
                    "date": 1767938256099,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -102,12 +102,21 @@\n \n \n \n \n-async function getEventTypeId() {\n-  // If you use ListingType model (dynamic types)\n-  // Keep key = \"event\" in DB for event type\n-  const t = await ListingType.findOne({ key: \"event\" }).select(\"_id\");\n+async function ensureEventTypeId() {\n+  // ListingType schema usually: { name, description, isActive }\n+  let t = await ListingType.findOne({ name: \"event\", isActive: true }).select(\"_id\");\n+\n+  // DEV mode me auto create\n+  if (!t && authDisabled()) {\n+    t = await ListingType.create({\n+      name: \"event\",\n+      description: \"Events\",\n+      isActive: true,\n+    });\n+  }\n+\n   return t?._id || null;\n }\n \n exports.getPublisherEvents = async (req, res) => {\n@@ -117,47 +126,35 @@\n     const pageNum = Math.max(parseInt(page, 10) || 1, 1);\n     const limitNum = Math.min(Math.max(parseInt(limit, 10) || 10, 1), 50);\n     const skip = (pageNum - 1) * limitNum;\n \n-    // ✅ DEV MODE: no auth => show all events OR allow publisherId filter via query\n+    // ✅ get event type ObjectId\n+    const eventTypeId = await ensureEventTypeId();\n+    if (!eventTypeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: \"ListingType 'event' not found. Create it first.\",\n+      });\n+    }\n+\n+    // ✅ publisherId resolution\n     let publisherId = null;\n \n     if (authDisabled()) {\n-      publisherId = req.query.publisherId || null; // optional\n+      publisherId = req.query.publisherId || null; // optional in dev\n     } else {\n-      // PROD mode: must have req.user\n-      if (!req.user?.id) {\n-        return res.status(401).json({ success: false, message: \"Unauthorized\" });\n-      }\n+      if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n       const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n-      if (!pub) {\n-        return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-      }\n+      if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n       publisherId = pub._id;\n     }\n \n-    const eventTypeId = await getEventTypeId();\n+    const filter = { type: eventTypeId }; // ✅ always ObjectId\n \n-    const filter = {};\n-\n-    // Filter by publisher if available\n     if (publisherId) filter.publisherId = publisherId;\n-\n-    // Filter by \"event\" type (supports both ObjectId-based and string-based schemas)\n-    if (eventTypeId) {\n-      filter.$or = [{ type: eventTypeId }, { listingType: eventTypeId }, { type: \"event\" }];\n-    } else {\n-      filter.type = \"event\"; // fallback if ListingType not created yet\n-    }\n-\n-    // status filter (approved/pending/rejected/all)\n     if (status !== \"all\") filter.status = status;\n+    if (q?.trim()) filter.title = { $regex: q.trim(), $options: \"i\" };\n \n-    // search\n-    if (q?.trim()) {\n-      filter.title = { $regex: q.trim(), $options: \"i\" };\n-    }\n-\n     const [items, total] = await Promise.all([\n       Listing.find(filter).sort({ createdAt: -1 }).skip(skip).limit(limitNum),\n       Listing.countDocuments(filter),\n     ]);\n@@ -187,52 +184,50 @@\n       deadline,\n       startDate,\n       endDate,\n       attachments = [],\n-      publisherId: bodyPublisherId, // ✅ dev mode support\n+      publisherId: bodyPublisherId, // dev mode\n     } = req.body;\n \n     if (!title || !description) {\n       return res.status(400).json({ success: false, message: \"title and description are required\" });\n     }\n \n+    const eventTypeId = await ensureEventTypeId();\n+    if (!eventTypeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: \"ListingType 'event' not found. Create it first.\",\n+      });\n+    }\n+\n     let publisherId = null;\n-\n     if (authDisabled()) {\n-      // In dev mode you can pass publisherId from frontend until auth is ready\n       publisherId = bodyPublisherId || null;\n       if (!publisherId) {\n         return res.status(400).json({\n           success: false,\n-          message: \"DEV MODE: please send publisherId in body to create event\",\n+          message: \"DEV MODE: send publisherId in body to create event\",\n         });\n       }\n     } else {\n       if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n-\n       const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n       if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-\n       publisherId = pub._id;\n     }\n \n-    const eventTypeId = await getEventTypeId();\n-\n     const doc = await Listing.create({\n       publisherId,\n-      // supports both schemas:\n-      type: eventTypeId || \"event\",\n-      listingType: eventTypeId || undefined,\n-\n+      type: eventTypeId,       // ✅ ObjectId\n       title,\n       description,\n       location,\n       deadline,\n       startDate,\n       endDate,\n       attachments,\n-\n-      status: \"pending\", // admin approval\n+      status: \"pending\",\n     });\n \n     return res.json({ success: true, message: \"Event created (pending approval)\", item: doc });\n   } catch (err) {\n"
                },
                {
                    "date": 1767938686282,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,14 @@\n \n \n \n \n+const ListingType = require(\"../models/ListingType\");\n \n+async function getTypeIdByName(name) {\n+  const t = await ListingType.findOne({ name, isActive: true }).select(\"_id\");\n+  return t?._id || null;\n+}\n \n \n async function ensureEventTypeId() {\n   // ListingType schema usually: { name, description, isActive }\n"
                },
                {
                    "date": 1767938693896,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,9 +99,9 @@\n \n \n \n \n-const ListingType = require(\"../models/ListingType\");\n+// const ListingType = require(\"../models/ListingType\");\n \n async function getTypeIdByName(name) {\n   const t = await ListingType.findOne({ name, isActive: true }).select(\"_id\");\n   return t?._id || null;\n"
                },
                {
                    "date": 1767938718220,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,47 +125,40 @@\n }\n \n exports.getPublisherEvents = async (req, res) => {\n   try {\n-    const { status = \"all\", q = \"\", page = 1, limit = 10 } = req.query;\n+    const { status = \"all\", q = \"\", page = 1, limit = 10, publisherId } = req.query;\n \n-    const pageNum = Math.max(parseInt(page, 10) || 1, 1);\n-    const limitNum = Math.min(Math.max(parseInt(limit, 10) || 10, 1), 50);\n-    const skip = (pageNum - 1) * limitNum;\n-\n-    // ✅ get event type ObjectId\n-    const eventTypeId = await ensureEventTypeId();\n-    if (!eventTypeId) {\n+    const typeId = await getTypeIdByName(\"event\");\n+    if (!typeId) {\n       return res.status(400).json({\n         success: false,\n         message: \"ListingType 'event' not found. Create it first.\",\n       });\n     }\n \n-    // ✅ publisherId resolution\n-    let publisherId = null;\n+    const filter = { type: typeId };\n \n-    if (authDisabled()) {\n-      publisherId = req.query.publisherId || null; // optional in dev\n+    // DEV mode: you can pass publisherId in query\n+    if (process.env.DISABLE_AUTH === \"true\") {\n+      if (publisherId) filter.publisherId = publisherId;\n     } else {\n-      if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n-      const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n-      if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-      publisherId = pub._id;\n+      filter.publisherId = req.publisherId; // (or resolve via Publisher model)\n     }\n \n-    const filter = { type: eventTypeId }; // ✅ always ObjectId\n-\n-    if (publisherId) filter.publisherId = publisherId;\n     if (status !== \"all\") filter.status = status;\n     if (q?.trim()) filter.title = { $regex: q.trim(), $options: \"i\" };\n \n+    const pageNum = Math.max(parseInt(page, 10) || 1, 1);\n+    const limitNum = Math.min(Math.max(parseInt(limit, 10) || 10, 1), 50);\n+    const skip = (pageNum - 1) * limitNum;\n+\n     const [items, total] = await Promise.all([\n       Listing.find(filter).sort({ createdAt: -1 }).skip(skip).limit(limitNum),\n       Listing.countDocuments(filter),\n     ]);\n \n-    return res.json({\n+    res.json({\n       success: true,\n       items,\n       pagination: {\n         page: pageNum,\n@@ -174,13 +167,14 @@\n         pages: Math.ceil(total / limitNum),\n       },\n     });\n   } catch (err) {\n-    console.error(\"getPublisherEvents error:\", err);\n-    return res.status(500).json({ success: false, message: err.message });\n+    console.log(\"getPublisherEvents error:\", err);\n+    res.status(500).json({ success: false, message: err.message });\n   }\n };\n \n+\n exports.createPublisherEvent = async (req, res) => {\n   try {\n     const {\n       title,\n"
                },
                {
                    "date": 1767938729054,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -175,62 +175,43 @@\n \n \n exports.createPublisherEvent = async (req, res) => {\n   try {\n-    const {\n-      title,\n-      description,\n-      location,\n-      deadline,\n-      startDate,\n-      endDate,\n-      attachments = [],\n-      publisherId: bodyPublisherId, // dev mode\n-    } = req.body;\n+    const typeId = await getTypeIdByName(\"event\");\n+    if (!typeId) {\n+      return res.status(400).json({\n+        success: false,\n+        message: \"ListingType 'event' not found. Create it first.\",\n+      });\n+    }\n \n+    const { title, description, publisherId, location, startDate, endDate } = req.body;\n+\n     if (!title || !description) {\n-      return res.status(400).json({ success: false, message: \"title and description are required\" });\n+      return res.status(400).json({ success: false, message: \"title and description required\" });\n     }\n \n-    const eventTypeId = await ensureEventTypeId();\n-    if (!eventTypeId) {\n+    // DEV mode: require publisherId in body\n+    if (process.env.DISABLE_AUTH === \"true\" && !publisherId) {\n       return res.status(400).json({\n         success: false,\n-        message: \"ListingType 'event' not found. Create it first.\",\n+        message: \"DEV MODE: send publisherId in body\",\n       });\n     }\n \n-    let publisherId = null;\n-    if (authDisabled()) {\n-      publisherId = bodyPublisherId || null;\n-      if (!publisherId) {\n-        return res.status(400).json({\n-          success: false,\n-          message: \"DEV MODE: send publisherId in body to create event\",\n-        });\n-      }\n-    } else {\n-      if (!req.user?.id) return res.status(401).json({ success: false, message: \"Unauthorized\" });\n-      const pub = await Publisher.findOne({ userId: req.user.id }).select(\"_id\");\n-      if (!pub) return res.status(404).json({ success: false, message: \"Publisher profile not found\" });\n-      publisherId = pub._id;\n-    }\n-\n     const doc = await Listing.create({\n       publisherId,\n-      type: eventTypeId,       // ✅ ObjectId\n+      type: typeId,           // ✅ ObjectId\n       title,\n       description,\n\\ No newline at end of file\n       location,\n-      deadline,\n       startDate,\n       endDate,\n-      attachments,\n       status: \"pending\",\n     });\n \n-    return res.json({ success: true, message: \"Event created (pending approval)\", item: doc });\n+    res.json({ success: true, message: \"Event created\", item: doc });\n   } catch (err) {\n-    console.error(\"createPublisherEvent error:\", err);\n-    return res.status(500).json({ success: false, message: err.message });\n+    console.log(\"createPublisherEvent error:\", err);\n+    res.status(500).json({ success: false, message: err.message });\n   }\n-};\n+};\n"
                }
            ],
            "date": 1766931140119,
            "name": "Commit-0",
            "content": "const Listing = require(\"../models/Listing\");\nconst Publisher = require(\"../models/Publisher\");\n\n\n// DASHBOARD SUMMARY\nexports.getDashboardSummary = async (req, res) => {\n  try {\n    const publisher = await Publisher.findOne({ userId: req.user.id });\n    if (!publisher) {\n      return res.status(404).json({\n        success: false,\n        message: \"Publisher profile not found\"\n      });\n    }\n\n    // Count by type\n    const counts = await Listing.aggregate([\n      { $match: { publisherId: publisher._id } },\n      {\n        $group: {\n          _id: \"$type\",\n          count: { $sum: 1 }\n        }\n      }\n    ]);\n\n    // Convert aggregation results into object { typeId: count }\n    const countMap = {};\n    counts.forEach(item => (countMap[item._id] = item.count));\n\n    // Pending, Approved, Rejected counts\n    const statusCounts = await Listing.aggregate([\n      { $match: { publisherId: publisher._id } },\n      {\n        $group: {\n          _id: \"$status\",\n          count: { $sum: 1 }\n        }\n      }\n    ]);\n\n    const statusMap = {};\n    statusCounts.forEach(s => (statusMap[s._id] = s.count));\n\n    res.json({\n      success: true,\n      counts: countMap,\n      statusCounts: statusMap\n    });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n\n// RECENT LISTINGS\nexports.getRecentListings = async (req, res) => {\n  try {\n    const publisher = await Publisher.findOne({ userId: req.user.id });\n\n    const listings = await Listing.find({ publisherId: publisher._id })\n      .populate(\"type\", \"name\")\n      .sort({ createdAt: -1 })\n      .limit(5);\n\n    res.json({\n      success: true,\n      listings\n    });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n\n// SUBSCRIPTION INFO\nexports.getSubscriptionInfo = async (req, res) => {\n  try {\n    const publisher = await Publisher.findOne({ userId: req.user.id });\n\n    res.json({\n      success: true,\n      subscriptionStatus: publisher.subscriptionStatus,\n      expiry: publisher.subscriptionExpiry,\n      servicePlanActive: publisher.servicePlanActive\n    });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n"
        }
    ]
}