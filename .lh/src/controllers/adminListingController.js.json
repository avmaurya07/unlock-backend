{
    "sourceFile": "src/controllers/adminListingController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1766930838641,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766933434583,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,16 +1,182 @@\n+const mongoose = require(\"mongoose\");\n const Listing = require(\"../models/Listing\");\n \n-exports.getPendingListings = async (req, res) => {\n-  const listings = await Listing.find({ status: \"pending\" }).populate(\"type\", \"name\");\n-  res.json({ success: true, listings });\n+const isValidObjectId = (id) => mongoose.Types.ObjectId.isValid(id);\n+\n+exports.adminListListings = async (req, res) => {\n+  try {\n+    const {\n+      status,        // pending | approved | rejected\n+      type,          // ListingType ObjectId\n+      publisherId,   // Publisher ObjectId\n+      q,             // search text\n+      from,          // YYYY-MM-DD (createdAt >=)\n+      to,            // YYYY-MM-DD (createdAt <=)\n+      page = 1,\n+      limit = 20,\n+      sort = \"new\"   // new | old\n+    } = req.query;\n+\n+    // pagination sanitize\n+    const p = Math.max(parseInt(page, 10) || 1, 1);\n+    const l = Math.min(Math.max(parseInt(limit, 10) || 20, 1), 100);\n+    const skip = (p - 1) * l;\n+\n+    const filter = {};\n+\n+    if (status) {\n+      if (![\"pending\", \"approved\", \"rejected\"].includes(status)) {\n+        return res.status(400).json({ success: false, message: \"Invalid status filter\" });\n+      }\n+      filter.status = status;\n+    }\n+\n+    if (type) {\n+      if (!isValidObjectId(type)) {\n+        return res.status(400).json({ success: false, message: \"Invalid type id\" });\n+      }\n+      filter.type = type;\n+    }\n+\n+    if (publisherId) {\n+      if (!isValidObjectId(publisherId)) {\n+        return res.status(400).json({ success: false, message: \"Invalid publisherId\" });\n+      }\n+      filter.publisherId = publisherId;\n+    }\n+\n+    // Date range filter on createdAt\n+    if (from || to) {\n+      filter.createdAt = {};\n+      if (from) filter.createdAt.$gte = new Date(from);\n+      if (to) {\n+        // include whole day\n+        const end = new Date(to);\n+        end.setHours(23, 59, 59, 999);\n+        filter.createdAt.$lte = end;\n+      }\n+    }\n+\n+    // Search (basic). If you added text index, switch to $text for better performance.\n+    if (q && q.trim()) {\n+      const keyword = q.trim();\n+      filter.$or = [\n+        { title: { $regex: keyword, $options: \"i\" } },\n+        { description: { $regex: keyword, $options: \"i\" } },\n+      ];\n+    }\n+\n+    const sortObj = sort === \"old\" ? { createdAt: 1 } : { createdAt: -1 };\n+\n+    const [total, listings] = await Promise.all([\n+      Listing.countDocuments(filter),\n+      Listing.find(filter)\n+        .sort(sortObj)\n+        .skip(skip)\n+        .limit(l)\n+        .populate(\"type\", \"name\")\n+        .populate({\n+          path: \"publisherId\",\n+          select: \"companyName userId\",\n+          populate: { path: \"userId\", select: \"name email\" }\n+        }),\n+    ]);\n+\n+    const totalPages = Math.ceil(total / l) || 1;\n+\n+    return res.json({\n+      success: true,\n+      meta: {\n+        page: p,\n+        limit: l,\n+        total,\n+        totalPages,\n+        hasNext: p < totalPages,\n+        hasPrev: p > 1,\n+      },\n+      listings,\n+    });\n+  } catch (err) {\n+    return res.status(500).json({ success: false, message: err.message });\n+  }\n };\n \n-exports.approveListing = async (req, res) => {\n-  await Listing.findByIdAndUpdate(req.params.id, { status: \"approved\" });\n-  res.json({ success: true, message: \"Listing approved\" });\n+exports.adminGetListingById = async (req, res) => {\n+  try {\n+    const { id } = req.params;\n+    if (!isValidObjectId(id)) {\n+      return res.status(400).json({ success: false, message: \"Invalid listing id\" });\n+    }\n+\n+    const listing = await Listing.findById(id)\n+      .populate(\"type\", \"name description\")\n+      .populate({\n+        path: \"publisherId\",\n+        select: \"companyName website userId\",\n+        populate: { path: \"userId\", select: \"name email phone\" }\n+      })\n+      .populate(\"reviewedBy\", \"name email\");\n+\n+    if (!listing) {\n+      return res.status(404).json({ success: false, message: \"Listing not found\" });\n+    }\n+\n+    return res.json({ success: true, listing });\n+  } catch (err) {\n+    return res.status(500).json({ success: false, message: err.message });\n+  }\n };\n \n-exports.rejectListing = async (req, res) => {\n-  await Listing.findByIdAndUpdate(req.params.id, { status: \"rejected\" });\n-  res.json({ success: true, message: \"Listing rejected\" });\n+exports.adminApproveListing = async (req, res) => {\n+  try {\n+    const { id } = req.params;\n+    if (!isValidObjectId(id)) {\n+      return res.status(400).json({ success: false, message: \"Invalid listing id\" });\n+    }\n+\n+    const listing = await Listing.findById(id);\n+    if (!listing) {\n+      return res.status(404).json({ success: false, message: \"Listing not found\" });\n+    }\n+\n+    listing.status = \"approved\";\n+    listing.approvedAt = new Date();\n+    listing.rejectedAt = null;\n+    listing.rejectionReason = null;\n+    listing.reviewedBy = req.user.id;\n+\n+    await listing.save();\n+\n+    return res.json({ success: true, message: \"Listing approved\", listing });\n+  } catch (err) {\n+    return res.status(500).json({ success: false, message: err.message });\n+  }\n };\n+\n+exports.adminRejectListing = async (req, res) => {\n+  try {\n+    const { id } = req.params;\n+    const { reason } = req.body;\n+\n+    if (!isValidObjectId(id)) {\n+      return res.status(400).json({ success: false, message: \"Invalid listing id\" });\n+    }\n+\n+    const listing = await Listing.findById(id);\n+    if (!listing) {\n+      return res.status(404).json({ success: false, message: \"Listing not found\" });\n+    }\n+\n+    listing.status = \"rejected\";\n+    listing.rejectedAt = new Date();\n+    listing.approvedAt = null;\n+    listing.rejectionReason = (reason || \"\").trim() || \"Rejected by admin\";\n+    listing.reviewedBy = req.user.id;\n+\n+    await listing.save();\n+\n+    return res.json({ success: true, message: \"Listing rejected\", listing });\n+  } catch (err) {\n+    return res.status(500).json({ success: false, message: err.message });\n+  }\n+};\n"
                }
            ],
            "date": 1766930838641,
            "name": "Commit-0",
            "content": "const Listing = require(\"../models/Listing\");\n\nexports.getPendingListings = async (req, res) => {\n  const listings = await Listing.find({ status: \"pending\" }).populate(\"type\", \"name\");\n  res.json({ success: true, listings });\n};\n\nexports.approveListing = async (req, res) => {\n  await Listing.findByIdAndUpdate(req.params.id, { status: \"approved\" });\n  res.json({ success: true, message: \"Listing approved\" });\n};\n\nexports.rejectListing = async (req, res) => {\n  await Listing.findByIdAndUpdate(req.params.id, { status: \"rejected\" });\n  res.json({ success: true, message: \"Listing rejected\" });\n};\n"
        }
    ]
}