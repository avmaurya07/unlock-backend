{
    "sourceFile": "src/controllers/listingController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1766930782417,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766932870233,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,11 +12,13 @@\n     if (!validType) {\n       return res.status(400).json({ success: false, message: \"Invalid listing type\" });\n     }\n \n-    // Find publisher record\n+    // Find publisher\n     const publisher = await Publisher.findOne({ userId: req.user.id });\n-    if (!publisher) return res.status(404).json({ success: false, message: \"Publisher not found\" });\n+    if (!publisher) {\n+      return res.status(404).json({ success: false, message: \"Publisher not found\" });\n+    }\n \n     const listing = await Listing.create({\n       publisherId: publisher._id,\n       type,\n"
                },
                {
                    "date": 1766932891989,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,8 +18,34 @@\n     if (!publisher) {\n       return res.status(404).json({ success: false, message: \"Publisher not found\" });\n     }\n \n+    // Validate attachments (optional)\n+    let safeAttachments = [];\n+    if (attachments) {\n+      if (!Array.isArray(attachments)) {\n+        return res.status(400).json({ success: false, message: \"attachments must be an array\" });\n+      }\n+\n+      if (attachments.length > 10) {\n+        return res.status(400).json({ success: false, message: \"Max 10 attachments allowed\" });\n+      }\n+\n+      for (const a of attachments) {\n+        if (!a?.url || !a?.publicId) {\n+          return res.status(400).json({\n+            success: false,\n+            message: \"Each attachment must contain url and publicId\"\n+          });\n+        }\n+        safeAttachments.push({\n+          url: a.url,\n+          publicId: a.publicId,\n+          resourceType: a.resourceType || \"image\"\n+        });\n+      }\n+    }\n+\n     const listing = await Listing.create({\n       publisherId: publisher._id,\n       type,\n       title,\n"
                },
                {
                    "date": 1766932916900,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,9 +53,10 @@\n       location,\n       deadline,\n       startDate,\n       endDate,\n-      attachments\n+       attachments: safeAttachments,\n+      status: \"pending\"\n     });\n \n     res.json({\n       success: true,\n"
                },
                {
                    "date": 1766933032714,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -75,9 +75,26 @@\n   try {\n     const updates = req.body;\n \n     const publisher = await Publisher.findOne({ userId: req.user.id });\n+    if (!publisher) return res.status(404).json({ success: false, message: \"Publisher not found\" });\n \n+    // Optional attachments validation if provided\n+    if (updates.attachments) {\n+      if (!Array.isArray(updates.attachments)) {\n+        return res.status(400).json({ success: false, message: \"attachments must be an array\" });\n+      }\n+      if (updates.attachments.length > 10) {\n+        return res.status(400).json({ success: false, message: \"Max 10 attachments allowed\" });\n+      }\n+\n+      updates.attachments = updates.attachments.map(a => ({\n+        url: a.url,\n+        publicId: a.publicId,\n+        resourceType: a.resourceType || \"image\"\n+      }));\n+    }\n+\n     const listing = await Listing.findOneAndUpdate(\n       { _id: req.params.id, publisherId: publisher._id },\n       updates,\n       { new: true }\n@@ -86,19 +103,20 @@\n     if (!listing) {\n       return res.status(404).json({ success: false, message: \"Listing not found\" });\n     }\n \n-    listing.status = \"pending\"; // any edit requires re-approval\n+    listing.status = \"pending\"; // force admin re-approval\n     await listing.save();\n \n-    res.json({ success: true, message: \"Listing updated\", listing });\n+    return res.json({ success: true, message: \"Listing updated and sent for re-approval\", listing });\n \n   } catch (err) {\n-    res.status(500).json({ success: false, message: err.message });\n+    return res.status(500).json({ success: false, message: err.message });\n   }\n };\n \n \n+\n // DELETE Listing\n exports.deleteListing = async (req, res) => {\n   try {\n     const publisher = await Publisher.findOne({ userId: req.user.id });\n"
                },
                {
                    "date": 1766933058171,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,8 @@\n const Listing = require(\"../models/Listing\");\n const ListingType = require(\"../models/ListingType\");\n const Publisher = require(\"../models/Publisher\");\n+const cloudinary = require(\"../config/cloudinary\");\n \n // CREATE Listing\n exports.createListing = async (req, res) => {\n   try {\n"
                },
                {
                    "date": 1766933080584,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -120,8 +120,9 @@\n // DELETE Listing\n exports.deleteListing = async (req, res) => {\n   try {\n     const publisher = await Publisher.findOne({ userId: req.user.id });\n+    if (!publisher) return res.status(404).json({ success: false, message: \"Publisher not found\" });\n \n     const listing = await Listing.findOneAndDelete({\n       _id: req.params.id,\n       publisherId: publisher._id\n@@ -130,12 +131,24 @@\n     if (!listing) {\n       return res.status(404).json({ success: false, message: \"Listing not found\" });\n     }\n \n-    res.json({ success: true, message: \"Listing deleted\" });\n+    // best-effort cleanup\n+    if (listing.attachments?.length) {\n+      for (const a of listing.attachments) {\n+        try {\n+          await cloudinary.uploader.destroy(a.publicId, { resource_type: a.resourceType || \"image\" });\n+        } catch (e) {\n+          // don't fail the request if cleanup fails\n+          console.error(\"Cloudinary delete failed:\", e.message);\n+        }\n+      }\n+    }\n \n+    return res.json({ success: true, message: \"Listing deleted\" });\n+\n   } catch (err) {\n-    res.status(500).json({ success: false, message: err.message });\n+    return res.status(500).json({ success: false, message: err.message });\n   }\n };\n \n \n"
                }
            ],
            "date": 1766930782417,
            "name": "Commit-0",
            "content": "const Listing = require(\"../models/Listing\");\nconst ListingType = require(\"../models/ListingType\");\nconst Publisher = require(\"../models/Publisher\");\n\n// CREATE Listing\nexports.createListing = async (req, res) => {\n  try {\n    const { type, title, description, location, deadline, startDate, endDate, attachments } = req.body;\n\n    // Validate type\n    const validType = await ListingType.findOne({ _id: type, isActive: true });\n    if (!validType) {\n      return res.status(400).json({ success: false, message: \"Invalid listing type\" });\n    }\n\n    // Find publisher record\n    const publisher = await Publisher.findOne({ userId: req.user.id });\n    if (!publisher) return res.status(404).json({ success: false, message: \"Publisher not found\" });\n\n    const listing = await Listing.create({\n      publisherId: publisher._id,\n      type,\n      title,\n      description,\n      location,\n      deadline,\n      startDate,\n      endDate,\n      attachments\n    });\n\n    res.json({\n      success: true,\n      message: \"Listing created successfully and is pending admin approval.\",\n      listing\n    });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n\n// UPDATE Listing\nexports.updateListing = async (req, res) => {\n  try {\n    const updates = req.body;\n\n    const publisher = await Publisher.findOne({ userId: req.user.id });\n\n    const listing = await Listing.findOneAndUpdate(\n      { _id: req.params.id, publisherId: publisher._id },\n      updates,\n      { new: true }\n    );\n\n    if (!listing) {\n      return res.status(404).json({ success: false, message: \"Listing not found\" });\n    }\n\n    listing.status = \"pending\"; // any edit requires re-approval\n    await listing.save();\n\n    res.json({ success: true, message: \"Listing updated\", listing });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n\n// DELETE Listing\nexports.deleteListing = async (req, res) => {\n  try {\n    const publisher = await Publisher.findOne({ userId: req.user.id });\n\n    const listing = await Listing.findOneAndDelete({\n      _id: req.params.id,\n      publisherId: publisher._id\n    });\n\n    if (!listing) {\n      return res.status(404).json({ success: false, message: \"Listing not found\" });\n    }\n\n    res.json({ success: true, message: \"Listing deleted\" });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n\n// GET My Listings\nexports.getMyListings = async (req, res) => {\n  try {\n    const publisher = await Publisher.findOne({ userId: req.user.id });\n\n    const listings = await Listing.find({ publisherId: publisher._id }).populate(\"type\", \"name\");\n\n    res.json({ success: true, listings });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n\n// PUBLIC: GET Approved Listings\nexports.getPublicListings = async (req, res) => {\n  try {\n    const listings = await Listing.find({ status: \"approved\" })\n      .populate(\"type\", \"name\");\n\n    res.json({ success: true, listings });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n\n// PUBLIC: GET Single Listing\nexports.getListingById = async (req, res) => {\n  try {\n    const listing = await Listing.findById(req.params.id)\n      .populate(\"type\", \"name\")\n      .populate(\"publisherId\", \"companyName\");\n\n    res.json({ success: true, listing });\n\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n"
        }
    ]
}